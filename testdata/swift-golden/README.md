# Swift Package Manager Golden Test Data

This directory contains test data for validating Swift Package Manager file parsing.

## Supported Formats

### âœ… Package.resolved (All Versions)

**Parser**: `SwiftPackageResolvedParser`  
**Status**: âœ… **Fully Supported**

Handles all three versions of the Package.resolved format:

- **Version 1**: Legacy format
- **Version 2**: Current format with state and pins
- **Version 3**: Latest format with identity field

**Features**:
- Extracts package identity, location (URL), and pinned version
- Detects version pinning (exact versions vs ranges)
- Handles namespace extraction from GitHub URLs
- Comprehensive version support across all Swift Package Manager releases

### âœ… Package.swift.json (Dumped Manifest)

**Parser**: `SwiftManifestJsonParser`  
**Status**: âœ… **Fully Supported**

Generated by `swift package dump-package` command from Package.swift manifests.

**Features**:
- BLAKE3 hash-based caching for performance optimization
- Extracts dependencies with all requirement types:
  - Exact version: `"1.0.0"`
  - Version range: `"1.0.0"..<"2.0.0"`
  - Branch: `"main"`, `"develop"`
  - Revision: Git commit SHA
- Platform-specific dependency handling
- Product and target dependency resolution

**Performance Optimization**: Uses BLAKE3 hashing to cache parsed manifests, avoiding expensive `swift package dump-package` calls for unchanged files.

## Current Implementation Status

### âœ… What Works (100% Feature Parity)

All Swift Package Manager JSON formats are fully supported with feature parity or better than Python ScanCode Toolkit:

1. **Package.resolved parsing**:
   - âœ… All three version formats
   - âœ… Dependency extraction with pinned versions
   - âœ… URL-based namespace extraction
   - âœ… State tracking (pinned, branch, revision)

2. **Package.swift.json parsing**:
   - âœ… All dependency requirement types
   - âœ… Direct vs transitive dependency detection
   - âœ… Version pinning analysis
   - âœ… BLAKE3 caching (improvement over Python)

### ðŸ”¬ Rust-Specific Improvements

The Rust implementation provides several enhancements:

1. **BLAKE3 Caching** (SwiftManifestJsonParser):
   - Faster than Python's approach
   - Avoids re-parsing unchanged Package.swift files
   - Cryptographically secure hash function

2. **Better Error Handling**:
   - Graceful degradation on parse errors
   - No panics in library code
   - Clear error messages via logging

3. **Type Safety**:
   - Compile-time guarantees for version formats
   - Exhaustive pattern matching for all version types
   - Zero-cost abstractions

## Python Reference Implementation

Location: `../../reference/scancode-toolkit/src/packagedcode/swift.py`

The Rust implementation achieves full feature parity with the Python reference while providing performance and safety improvements.

## License Detection Blockers

**All golden tests may have mismatches in license-related fields** because:
- License detection engine is not yet implemented in Rust version
- Fields affected: `declared_license_expression`, `declared_license_expression_spdx`, `license_detections`
- **This is expected** and not a parser limitation

The test comparator (`compare_package_data_parser_only`) automatically skips license detection fields during comparison, focusing on package and dependency extraction accuracy.

## Test Data Structure

```
swift-golden/
â”œâ”€â”€ packages/           # Package.resolved test files
â”œâ”€â”€ manifests/          # Package.swift.json test files
â””â”€â”€ resolved/           # Additional Package.resolved variants
```

Each test file should have a corresponding `-expected.json` file for golden test comparison.

## Running Tests

```bash
# Run all Swift golden tests
cargo test --lib swift_golden

# Run specific test
cargo test --lib test_golden_swift_package_resolved_v2
```

## Expected Test Results

All Swift golden tests should pass with 100% accuracy for:
- Package identity extraction
- Dependency PURL generation
- Version requirement parsing
- Pinning detection
- Direct dependency flagging

Any failures indicate a regression and should be investigated immediately.
